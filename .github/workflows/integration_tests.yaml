name: Integration Tests

on:
  workflow_dispatch:
    inputs:
      module:
        required: false
        description: The single module to update (by default all will be updated)

jobs:
  build:
    runs-on: ubuntu-20.04

    outputs:
      commit_ref: ${{ steps.build.outputs.commit_ref }}
      build_id: ${{ steps.build.outputs.build_id }}

    if: ${{ github.repository == 'atsign-foundation/at_mono' }}
    steps:
      - uses: actions/checkout@v3

      - name: Build
        id: build
        uses: ./.github/composite/build
        with:
          module: ${{ github.event.inputs.module }}

  at_server_tests:
    needs: build
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v3
        with:
          ref: ${{ needs.build.outputs.commit_ref }}
          submodules: recursive

      - name: Retrieve build cache
        uses: ./.github/composite/build
        with:
          build_id: ${{ needs.build.outputs.build_id }}

      - name: "Lockfile Sanity Check"
        run: |
          cat ./modules/at_client_sdk/at_client/pubspec.lock | grep -A 6 "at_commons:"
